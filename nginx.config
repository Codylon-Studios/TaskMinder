#=======================================================================
# NGINX REVERSE PROXY CONFIGURATION
#
# This file manages multiple domains, redirecting HTTP to HTTPS and
# proxying requests to backend applications.
#=======================================================================
#
# HOW TO USE THIS TEMPLATE:
#
# 1. Replace placeholder domains (e.g., codylon.de, taskminder.de)
#    with your own domain names.
#
# 2. Update SSL certificate paths to match your domain's certificates,
#    typically found in `/etc/letsencrypt/live/your-domain.com/`.
#
# 3. Adjust the `proxy_pass` directive to point to the correct
#    address and port of your backend application (e.g., http://localhost:3000).
#
#-----------------------------------------------------------------------
# CERTBOT (LET'S ENCRYPT) SETUP NOTES:
#
# - To obtain your first SSL certificate, start with only the `listen 80`
#   server block. This allows Certbot's HTTP-01 challenge to succeed.
#
# - After Certbot has successfully created your certificates, you can
#   enable the full HTTPS configuration below (the `listen 443 ssl` blocks).
#
# - The `.well-known/acme-challenge` location in the HTTP block is
#   essential and must be kept for automatic certificate renewals.
#
#=======================================================================


#=======================================================================
# DOMAIN 1: codylon.de
# Proxies requests to a backend application on port 3000.
#=======================================================================

# Block 1.1: Redirect all HTTP traffic to HTTPS
#-----------------------------------------------------------------------
server {
    listen 80;
    server_name codylon.de www.codylon.de;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# Block 1.2: Redirect www to non-www for a canonical URL (HTTPS)
#-----------------------------------------------------------------------
server {
    listen 443 ssl http2;
    server_name www.codylon.de;

    # SSL Configuration (managed by Certbot)
    # NOTE: This block requires a valid certificate to handle the redirect.
    ssl_certificate /etc/letsencrypt/live/codylon.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/codylon.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://codylon.de$request_uri;
}

# Block 1.3: Main server for https://codylon.de
#-----------------------------------------------------------------------
server {
    listen 443 ssl http2;
    server_name codylon.de;

    # SSL Configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/codylon.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/codylon.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    server_tokens off;
    client_max_body_size 20m;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}


#=======================================================================
# DOMAIN 2: taskminder.de
# Proxies requests for the root domain and a subdomain to different
# backend applications.
#=======================================================================

# Block 2.1: Redirect all HTTP traffic to HTTPS
#-----------------------------------------------------------------------
server {
    listen 80;
    server_name taskminder.de www.taskminder.de monitoring.taskminder.de;

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# Block 2.2: Redirect www to non-www for a canonical URL (HTTPS)
#-----------------------------------------------------------------------
server {
    listen 443 ssl http2;
    server_name www.taskminder.de;

    # SSL Configuration (managed by Certbot)
    # NOTE: This certificate is for monitoring.taskminder.de but is a
    # "SAN certificate" that also covers taskminder.de and www.taskminder.de.
    ssl_certificate /etc/letsencrypt/live/monitoring.taskminder.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/monitoring.taskminder.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://taskminder.de$request_uri;
}

# Block 2.3: Main server for https://taskminder.de
#-----------------------------------------------------------------------
server {
    listen 443 ssl http2;
    server_name taskminder.de;

    # SSL Configuration (using the shared SAN certificate)
    ssl_certificate /etc/letsencrypt/live/monitoring.taskminder.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/monitoring.taskminder.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;


    server_tokens off;
    client_max_body_size 20m;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}

# Block 2.4: Subdomain server for https://monitoring.taskminder.de
#-----------------------------------------------------------------------
server {
    listen 443 ssl http2;
    server_name monitoring.taskminder.de;

    # SSL Configuration (using the shared SAN certificate)
    ssl_certificate /etc/letsencrypt/live/monitoring.taskminder.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/monitoring.taskminder.de/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    server_tokens off;
    client_max_body_size 20m;

    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }
}