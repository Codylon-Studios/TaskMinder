generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  accountId     Int             @id @unique(map: "account_account_id") @default(autoincrement()) @map("accountId")
  username      String
  password      String
  deletedAt     BigInt?
  createdAt     BigInt?

  HomeworkCheck HomeworkCheck[]
  JoinedClass   JoinedClass?
  JoinedTeams   JoinedTeams[]
  Files         Upload[]

  // FIXME: account_username_unique_active_key partial index for
  // deletedAt and username; manual migration in: improve_schema 20251121
  // prisma does not have this natively implemented yet (11/22/2025)
  @@index([deletedAt])
  @@map("account")
}

model AccountSessions {
  sid    String   @id(map: "session_pkey") @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_session_expire")
  @@map("account_sessions")
}

model Event {
  eventId     Int       @id @default(autoincrement()) @map("eventId")
  classId     Int
  eventTypeId Int
  name        String
  description String?
  startDate   BigInt
  endDate     BigInt?
  lesson      String?
  teamId      Int
  createdAt   BigInt?    

  EventType   EventType @relation(fields: [eventTypeId], references: [eventTypeId], onDelete: Cascade, onUpdate: NoAction)
  Class       Class     @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@map("event")
}

model EventType {
  eventTypeId Int     @id @default(autoincrement()) @map("eventTypeId")
  classId     Int
  name        String
  color       String?
  createdAt   BigInt?

  Event       Event[]

  Class       Class   @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@unique([classId, name])
  @@map("eventType")
}

model Class {
  classId                 Int           @id @default(autoincrement()) @map("classId")
  className               String
  classCode               String        @unique
  classCreated            BigInt
  isTestClass             Boolean
  defaultPermissionLevel  Int
  storageUsedBytes        BigInt
  // total storage quota (bytes)
  storageQuotaBytes       BigInt
  dsbMobileActivated      Boolean
  dsbMobileUser           String?
  dsbMobilePassword       String?
  // real name of class to filter in substitution data
  dsbMobileClass          String?

  Event                   Event[]
  EventType               EventType[]
  Homework                Homework[]
  JoinedClass             JoinedClass[]
  Lesson                  Lesson[]
  Subjects                Subjects[]
  Team                    Team[]
  Files                   Upload[]

  @@map("class")
}

model Homework {
  homeworkId     Int             @id @default(autoincrement()) @map("homeworkId")
  classId        Int
  content        String
  subjectId      Int
  assignmentDate BigInt
  submissionDate BigInt
  teamId         Int
  createdAt      BigInt?

  HomeworkCheck  HomeworkCheck[]

  Class          Class           @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@map("homework")
}

model HomeworkCheck {
  checkId    Int      @id @default(autoincrement()) @map("checkId")
  accountId  Int
  homeworkId Int
  createdAt  BigInt?

  Account    Account  @relation(fields: [accountId], references: [accountId], onDelete: Cascade, onUpdate: NoAction)
  Homework   Homework @relation(fields: [homeworkId], references: [homeworkId], onDelete: Cascade, onUpdate: NoAction)

  @@index([accountId])
  @@unique([accountId, homeworkId], map: "homework_check_account_id_homework_id")
  @@map("homeworkCheck")
}

model JoinedClass {
  joinedClassId   Int     @id @default(autoincrement()) @map("joinedClassId")
  classId         Int
  accountId       Int     @unique
  permissionLevel Int
  createdAt       BigInt?

  Account         Account @relation(fields: [accountId], references: [accountId], onDelete: Cascade, onUpdate: NoAction)
  Class           Class   @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@map("joinedClass")
}

model JoinedTeams {
  joinedTeamId Int     @id @default(autoincrement()) @map("joinedTeamId")
  teamId       Int
  accountId    Int
  createdAt    BigInt?

  Account      Account @relation(fields: [accountId], references: [accountId], onDelete: Cascade, onUpdate: NoAction)
  Team         Team    @relation(fields: [teamId], references: [teamId], onDelete: Cascade, onUpdate: NoAction)

  @@index([accountId])
  @@unique([teamId, accountId], map: "joined_teams_team_id_account_id")
  @@map("joinedTeams")
}

model Lesson {
  lessonId     Int    @id @default(autoincrement()) @map("lessonId")
  classId      Int
  lessonNumber Int
  weekDay      Int
  teamId       Int
  subjectId    Int
  room         String
  startTime    BigInt
  endTime      BigInt
  createdAt    BigInt?

  Class        Class  @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@unique([classId, teamId, weekDay, lessonNumber, subjectId])
  @@map("lesson")
}

model Subjects {
  subjectId               Int      @id @default(autoincrement()) @map("subjectId")
  classId                 Int
  subjectNameLong         String
  subjectNameShort        String
  subjectNameSubstitution String[]
  teacherGender           String
  teacherNameLong         String
  teacherNameShort        String
  teacherNameSubstitution String[]
  createdAt               BigInt?

  Class                   Class    @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@map("subjects")
}

model Team {
  teamId      Int           @id @default(autoincrement()) @map("teamId")
  classId     Int
  name        String
  createdAt   BigInt?

  JoinedTeams JoinedTeams[]

  Class       Class         @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@unique([classId, name])
  @@map("team")
}

model FileMetadata {
  fileMetaDataId   Int    @id @default(autoincrement())
  uploadId         Int
  storedFileName   String   @unique // unique UUID name on disk
  mimeType         String
  size             Int
  createdAt        BigInt

  Upload Upload @relation(fields: [uploadId], references: [uploadId], onDelete: Cascade, onUpdate: NoAction)
  @@map("fileMetadata")
}

// an upload can contain one or multiple files
model Upload {
  uploadId      Int    @id @default(autoincrement())
  uploadName    String 
  uploadType    String
  status        String @default("queued") // "queued" | "processing" | "completed" | "failed"
  errorReason   String?
  reservedBytes BigInt @default(0) // Storage reserved during upload
  createdAt     BigInt  // When the upload job was created

  teamId        Int
  accountId     Int?
  classId       Int

  Files         FileMetadata[]

  Account       Account?   @relation(fields: [accountId], references: [accountId], onDelete: SetNull, onUpdate: NoAction)
  Class         Class      @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)

  @@index([classId])
  @@map("upload")
}